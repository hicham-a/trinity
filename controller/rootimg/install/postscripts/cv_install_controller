#! /usr/bin/bash
##title          : cv_install_controller
##description    : Installs an xCAT controller node. Additionally it also configures
##                 the xCAT web service 
##author         : Hans Then & Abhishek Mukherjee
##email          : hans.then@clustervision
##                 abhishek.mukherjee@clustervision.com


#--------------------------------------------------------------------------------------
# install xcat
#--------------------------------------------------------------------------------------
# determine if a master is used to install this node:
if [ ! -z $SITEMASTER ]; then
    echo master is present
    mkdir /tmp/trinity
    mount ${SITEMASTER}:/trinity /tmp/trinity       
    echo "Creating installation tree"
    source /etc/profile.d/xcat.sh
    copycds -n centos7 -o $(ls -cr /tmp/trinity/iso/*.iso | head -1) > /dev/null
else
    echo No master found, checking for a git repository.
    SCRIPT=$(readlink -f $0)
    SCRIPTDIR=$(dirname $SCRIPT)
    REPODIR=$(readlink -f $SCRIPTDIR/../../../../)
    echo Found repository in $REPODIR
    cp -Lrv --preserve $REPODIR /tmp

    # Fix #379
    cd $REPODIR
    (git branch | grep "*"; git describe; git status --porcelain) > /tmp/trinity/version
    cd -

    # setup repositories
    yum -y -q install $(grep -v ^# $REPODIR/controller/rootimg/install/custom/install/centos/controller.pkglist)
    yum -y -q install epel-release
    yum -y -q install https://repos.fedorapeople.org/repos/openstack/EOL/openstack-juno/rdo-release-juno-1.noarch.rpm
    sed -i "/^baseurl/s/openstack-juno/EOL\/openstack-juno/" /etc/yum.repos.d/rdo-release.repo

    wget --no-check-certificate http://sourceforge.net/projects/xcat/files/yum/2.9/xcat-core/xCAT-core.repo -O /etc/yum.repos.d/xCAT-core.repo
    wget --no-check-certificate http://sourceforge.net/projects/xcat/files/yum/xcat-dep/rh7/x86_64/xCAT-dep.repo -O /etc/yum.repos.d/xCAT-dep.repo
    yum -y -q install $(grep -v ^# $REPODIR/controller/rootimg/install/custom/install/centos/controller.otherpkgs)
    source /etc/profile.d/xcat.sh
    mkdir -p /tmp/trinity/iso
    echo Downloading cd, this may take a while
    wget -c http://mirror.denit.net/centos/7/isos/x86_64/CentOS-7-x86_64-Everything-1511.iso \
         -P /tmp/trinity/iso/

    echo "Creating installation tree"
    copycds -n centos7 -o $(ls -cr /tmp/trinity/iso/*.iso | head -1) > /dev/null
fi

systemctl stop NetworkManager
systemctl disable NetworkManager
killall dhclient
# disable the dhcp based ntp
# rm /etc/dhcp/dhclient.d/ntp.sh
if ! systemctl restart network; then
    sleep 3
    systemctl start network
fi

mkdir -p /trinity

# create runimages
#--------------------------------------------------------------------------------------
if [[ -d /install/runimages ]]; then
    for file in $(ls /install/runimages); do
        if [ -d /install/runimages/${file} ]; then 
            tar czf /install/runimages/${file}.tgz -C /install/runimages/${file}/ .
        fi
    done
fi

#--------------------------------------------------------------------------------------
# copy default database configuration
# and patch the installation
#--------------------------------------------------------------------------------------
source /etc/profile.d/xcat.sh
mkdir -p /tmp/xcattables

# FIXME: make these configurable
read ETH1 ETH2 ETH3 <<<$(ls /sys/class/net/ | grep "^e" | sort | head -3)
for table in $(ls /tmp/trinity/controller/xcat/tables); do
    sed -e "s/\<eno1\>/$ETH1/g" -e "s/\<eno2\>/$ETH2/g"  -e "s/\<eno3\>/$ETH3/g" /tmp/trinity/controller/xcat/tables/$table > /tmp/xcattables/$table;
done

restorexCATdb -p /tmp/xcattables  
chtab key=timezone site.value=$(timedatectl | grep "Time zone" | grep -oP "Time zone: \K\S+")

cd /opt/xcat/share/xcat/netboot/centos

ln -s ../rh/dracut_033 .
ln -s ../rh/dracut .

cd /
cat /tmp/trinity/controller/xcat/patches/*.patch | patch -p0
mknb x86_64
systemctl restart xcatd
setenforce 0
sestatus

#
hostname controller.cluster
hostnamectl set-hostname controller.cluster
makedhcp -n
makehosts -n
makedns -n

# Fix for #356
systemctl disable firewalld

# setup NAT, so nodes can access the internet (see manual step 1.f)
chkconfig iptables on
service iptables start
modprobe iptable_nat
iptables -A FORWARD -i $ETH2 -j ACCEPT
iptables -t nat -A POSTROUTING -o $ETH1 -j MASQUERADE
iptables -D FORWARD -j REJECT --reject-with icmp-host-prohibited
iptables -D INPUT -j REJECT --reject-with icmp-host-prohibited
service iptables save

#--------------------------------------------------------------------------------------
# copy required files from the master node to the controller node
#--------------------------------------------------------------------------------------
cp -LrT /tmp/trinity/clustervision /trinity/clustervision &
cp -LrT /tmp/trinity/controller/rootimg /
cp /tmp/trinity/version /trinity/version

if [[ -f /tmp/trinity/site ]]; then
   cp /tmp/trinity/site /trinity/site
fi

#--------------------------------------------------------------------------------------
# setup routing for the virtual clusters
#--------------------------------------------------------------------------------------
ip route add 172.16.0.0/12 dev $ETH2
mv /etc/sysconfig/network-scripts/route-eno2 /etc/sysconfig/network-scripts/route-${ETH2} 2> /dev/null

#--------------------------------------------------------------------------------------
# Additional network processing
#--------------------------------------------------------------------------------------
# remove the default route from other devices
for file in /etc/sysconfig/network-scripts/ifcfg-{$ETH2,$ETH3}; do
    sed -i $file -e "s/DEFROUTE=\(.*\)/DEFROUTE=no/"
done


# disable default route
sed -i /etc/sysconfig/network-scripts/ifcfg-$ETH1 -e "s/DEFROUTE=\(.*\)/DEFROUTE=yes/" 
# HTH: we no longer disable peerdns in R7
# -e "s/PEERDNS=\(.*\)/PEERDNS=no/"

# Fix for #85
if [[ ! -z "$ETH2" ]]; then
cat >> /etc/sysconfig/network-scripts/ifcfg-$ETH2 << EOF
IPADDR1=10.148.255.254
PREFIX1=16
GATEWAY1=10.148.255.254
EOF
ip a a 10.148.255.254/16 dev $ETH2
fi


systemctl restart network
systemctl enable ntpd
systemctl start ntpd

#--------------------------------------------------------------------------------------
# Start opensm on the controller
#--------------------------------------------------------------------------------------
yum -y -q groupinstall "Infiniband Support"
yum -y -q install opensm
yum -y -q install infiniband-diags

systemctl enable opensm
systemctl start opensm

#--------------------------------------------------------------------------------------
# now setup NFS exports
#--------------------------------------------------------------------------------------
systemctl enable nfs-server
systemctl start nfs-server
exportfs -a

#--------------------------------------------------------------------------------------
# Selective updates
#--------------------------------------------------------------------------------------
yum -y -q install epel-release
yum -y -q install https://repos.fedorapeople.org/repos/openstack/EOL/openstack-juno/rdo-release-juno-1.noarch.rpm
sed -i "/^baseurl/s/openstack-juno/EOL\/openstack-juno/" /etc/yum.repos.d/rdo-release.repo

yum-config-manager --disable xcat-otherpkgs* local-centos*
yum-config-manager --enable base epel extras updates openstack-juno
yum-config-manager --add-repo http://sourceforge.net/projects/xcat/files/yum/2.9/xcat-core/xCAT-core.repo
yum-config-manager --add-repo http://sourceforge.net/projects/xcat/files/yum/xcat-dep/rh7/x86_64/xCAT-dep.repo

mkdir -p /install/post/otherpkgs/centos7/x86_64
if [ -z $SITEMASTER ]; then
    reposync -n -r epel -r extras -r updates -r xcat-2-core -r xcat-dep -r openstack-juno -p /install/post/otherpkgs/centos7/x86_64/
else
    reposync -n -r xcat-otherpkgs0 -p /install/post/otherpkgs/centos7/x86_64/
fi

createrepo /install/post/otherpkgs/centos7/x86_64/
(genimage centos7-x86_64-netboot-trinity; packimage centos7-x86_64-netboot-trinity) &
(genimage centos7-x86_64-netboot-nova; packimage centos7-x86_64-netboot-nova) &

#--------------------------------------------------------------------------------------
# install docker and docker-registry
# and create the trinity image for the compute nodes
#--------------------------------------------------------------------------------------
yum -y -q install docker docker-registry
# FIXME: move this to the rootimg profile
sed -i 's/REGISTRY_PORT=.*/REGISTRY_PORT=5050/' /etc/sysconfig/docker-registry

systemctl enable docker docker-registry
systemctl start docker docker-registry

if [ -z ${SITEMASTER} ]; then
    docker build -t controller:5050/trinity /trinity/container
else
    docker pull ${SITEMASTER}:5050/trinity
    docker tag ${SITEMASTER}:5050/trinity controller:5050/trinity
fi
docker push controller:5050/trinity &
chmod -x /usr/lib/systemd/system/*

#--------------------------------------------
# Install the xCAT web service
#--------------------------------------------
# The xCAT web service requires the following
yum -y -q install mod_ssl
service httpd restart
yum -y -q install perl-JSON

# Set up the xCAT web service
useradd trinity
echo "trinity" | passwd trinity --stdin
source /etc/profile.d/xcat.sh
export HOME=/root
tabch key=xcat,username=trinity passwd.password=trinity
mkdef -t policy 6 name=trinity rule=allow
sed  -e "/<Directory \/>/,/<\/Directory>/ s/Require/#Require/" -i /etc/httpd/conf/httpd.conf
service httpd restart

wait 

echo "$0 finished @ $(date)" >> /var/log/postinstall.log
